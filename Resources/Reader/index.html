<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Title - My 3D Comic - Chapter 1 - Beginning</title>
		<meta name="author" content="3D Comic Creator Extraordaire">
		<meta name="description" content="New 3D Comic - Chapter 1 - Beginning">
		<meta name="keywords" content="3DComic, 3D Comic, Webtoon, Webcomic, Digital Comic, Spiraloid, Online Graphic Novel, Graphic Novel, 3D Art, 3D model, Concept Art, Digital Painting, VFX">

		<script>
			var next_issue_url = "https://3dcomic.shop/store";
			var previous_issue_url = null;
			var uncollectedBonuses = null;
			var developer_mode = false;

		</script>

		<!-- ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: -->
		<!-- ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: -->
		<!-- ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: -->

		<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
		<meta name="apple-mobile-web-app-capable" content="yes, user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1, minimal-ui">
		<meta content="text/html; charset=utf-8" http-equiv="Content-Type">


		<link href="./apple-touch-icon.png" rel="apple-touch-icon">
		<link href="https://3dcomic.shop/inkbots/SiteThumbnail.jpg" rel="image_src">
		<link href="./favicon.ico" rel="fav-icon">
		<link rel="manifest" href="./manifest.json">
		<html manifest="./cache.manifest">

		<link href="./styles.css" rel="stylesheet">
		<script src="js/reload.js"></script>
		<script src="js/three.js"></script>
		<script src="js/gltfloader.js"></script>
		<script src="files.js"></script>

		<script>
			var running_on_desktop;
			window.mobileCheck = function() {
				let check = false;
				(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
				return check;
			};

			if (!window.mobileCheck){
				running_on_desktop = false;
				if (window.applicationCache.status === window.applicationCache.UPDATEREADY)
				{
					window.applicationCache.update();
					window.applicationCache.swapCache();
				}
			}
			else
			{
				running_on_desktop = true;
			}
		</script>

		<script>history.scrollRestoration = "manual"</script>

		</head>
		<body class="body">

	</head>
	<body class="body">


		
		<div class="loadingScreen" id="loadingscreen" style=display:block >
			<div><img alt="" src="./images/loading_screen.gif" style="max-width:100%; height:auto; display: block; position: absolute; margin-right: -50%; top: 30%; left: 50%; transform: translate(-50%, -50%)"  href=""  ></div>
			<div  style="display: flex; align-items: center; justify-content: center">
				<span class="loadingspinner"><span class="loadingspinner-inner"></span></span>
			</div>
			<div style=" display: flex; align-items: center; justify-content: center"><img alt="By Bay Raitt" src="./images/singature.gif" style="max-width:11vmax; height:11vvmax; position: absolute; bottom: 0; "  href="https://gumroad.com/l/3dcomictoolkit"></div>

			
		</div>


		<canvas id="canvas"></canvas>
			<!-- the main container is openned. -->
			<div class="scrollable_content"  >
					<!-- The Home-Button -->
					<div style="width:100%">
							<a  href="https://3dcomic.shop/store/index.html">
									<!-- <div id="homebutton">◄Home</div> -->
									<img  id="homebutton" src="./images/home_button.png" alt="" width="100%" style="display: block;">

							</a>
					</div>

					<!-- The Bonus Badge -->
					<div style="width:100%">
						<a class="bonus_badge" href="https://gumroad.com/l/inkbots_bonus_panel_prize" >
								<span id="button_counter">99</span>
								<!-- <div id="homebutton">◄Home</div> -->
								<img  id="bonus_badge" src="./images/bonus_badge.png" alt="" width="100%" style="display: block;" >
						</a>
					</div>

					<!--  animated arrows -->
					<div style="width:100%; max-height:50vh;">
							<div class="scrollArrowLeft-wrapper">
								<span>S</br>C</br>R</br>O</br>L</br>L</span>
									<div class="scrollArrowLeft">
										<span>
											<br>
											<br>
											<br>
											<br>
											<br>	
											<div >
												<div class="arrowSliding">
													<div class="arrow"></div>
												</div>
												<div class="arrowSliding delay1">
													<div class="arrow"></div>
												</div>
												<div class="arrowSliding delay2">
													<div class="arrow"></div>
												</div>
												<div class="arrowSliding delay3">
													<div class="arrow"></div>
												</div>
											</div>
										</span>
									</div>
							</div>

							<div class="scrollArrowRight-wrapper">
								<span>S</br>C</br>R</br>O</br>L</br>L</span>
									<div class="scrollArrowRight">
										<span>
											<br>
											<br>
											<br>
											<br>
											<br>	
											<div >
												<div class="arrowSliding">
													<div class="arrow"></div>
												</div>
												<div class="arrowSliding delay1">
													<div class="arrow"></div>
												</div>
												<div class="arrowSliding delay2">
													<div class="arrow"></div>
												</div>
												<div class="arrowSliding delay3">
													<div class="arrow"></div>
												</div>
											</div>
										</span>
									</div>
							</div>
					</div>


					<!-- The WIP-Chapteer Box -->
					<div id="wipchapterboxbackground">
						<img alt="" height="100%" width="100%"  style  src="./images/construction_bar.jpg" style="display:block; margin-left: auto; margin-right: auto; ">
						<div id="wipchapterbox">
							<div>
								<center>
									<h1>Welcome to the latest installment of</h1>
									<div class="title_image" ><img alt="" height="100%" width="100%" src="./images/main_banner.jpg" ></div>
									<p>This chapter might 
									<font style="color:rgb(255, 255, 255);font-family:'Courier Prime';">
										<b>update often!</b>
									</font>
									</p>
									</center>
									<div align="left" style="transform: translateX(6vh);">
										<p>
										<font style="color:rgb(255, 255, 255);font-family:'Courier Prime';">
											Scroll up to read the story
											<br>
											Drag sideways to move camera
											<br>
											Aim and Release to capture hidden
										</font>

										<font style="color:rgb(122, 239, 255);font-family:'Audiowide'; ">
											<b>BONUSES!</b>
										</font>
									</div>
									<div>
										<div style=" margin: auto; width: 100%; display: block;"> 
											<img alt=""  width="100%" height="100%"  src="./images/bonus_guide.gif" style="display: block;"  href=""  >
										</div>
									</div>
									<center>
									<br>
									<div id="prize_banner"> 
										<img alt=""  width="100%" height="100%"  src="./images/prize_banner.png" style="display: block;"  href=""  >
									</div>
									<br>
								</center>
							</div>
						<img alt="" height="100%" width="100%"  style  src="./images/construction_bar.jpg" style="display:block; margin-left: auto; margin-right: auto; ">
					</div>

					<div class="coverwrapper">
							<div  style="width:100%; height:100%"><img id="shuffle" alt="" height="100%" src="./images/cover_black.gif" style="display: block;" width="100%"></div>
							<div style="width:100%; height:100%" id="coveroverlay"><img alt=""  height="100%" src="./images/page_curl_hint.gif" style="display: block;" width="100%"></div>
					</div>

		</div>




		<div id="awardCertificate" class="modal">

			<!-- Modal content -->
			<div class="modal-content">
				<span class="close">&times;</span>
				<center>
					<font style="font-size:1.25em;color:rgb(0, 0, 0);font-family:'Courier Prime';">
						<b>Congratulations!</b>
					</font>
					<font style="font-size:1.25em;color:rgb(0, 0, 0);font-family:'Courier Prime';">
						<br>
						<br>
						Collect prize 
						<div style="width:100%; height:32px; margin-left:auto; margin-right:auto; text-align:center; ">
							<a href="https://gum.co/inkbots_bonus_panel_prize">
								&#187 <b>HERE</b> &#171;
							</a>
						</div>
						<br>
						and enter discount code: 
						<br>
						<br>
						<font style="font-size:1.25em;color:rgb(185, 255, 200);font-family:'Courier Prime'; ">
							<b>"42"</b>
						</font>
						<br>
						<br>
					</font>
				</center>

			</div>
		</div>

		<script>
			// Get the modal
			var modal = document.getElementById("awardCertificate");

			// Get the <span> element that closes the modal
			var span = document.getElementsByClassName("close")[0];
		
			// When the user clicks on <span> (x), close the modal
			span.onclick = function() {
				modal.style.display = "none";
			}
			
			// When the user clicks anywhere outside of the modal, close it
			window.onclick = function(event) {
				if (event.target == modal) {
				modal.style.display = "none";
				}
			}
		</script>

		<div id="content"></div>


		<script>
			document.cookie = 'name=3dcomicshop; ; SameSite=Secure;'

			var canvas = document.getElementById( 'canvas' );
			var content = document.getElementById( 'content' );
			var isPlayingSound = false;
			var camera, scene, renderer, frustum;
			var scenes = [];
			var hasClicked = false;
			var panelCount;

			var isPointerDown = false;
			var pointer = new THREE.Vector2();
			var pointerOnDown = new THREE.Vector2();
			var raycaster = new THREE.Raycaster ();
			var isDragging = false;
			// var uncollectedBonuses = 0;
			const bonusSoundEffect = new Audio();
			
			var language = 'en';

			var isMobile = {
				Android: function() {
					return navigator.userAgent.match(/Android/i);
				},
				BlackBerry: function() {
					return navigator.userAgent.match(/BlackBerry/i);
				},
				iOS: function() {
					return navigator.userAgent.match(/iPhone|iPad|iPod/i);
				},
				Opera: function() {
					return navigator.userAgent.match(/Opera Mini/i);
				},
				Windows: function() {
					return navigator.userAgent.match(/IEMobile/i);
				},
				any: function() {
					return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
				}
			};


			//get all url parameters
			var progress = "0";
			path = window.location.href
			var parameters = path.split("?")[1]; 
			var para1 = parameters.split("&")[0];
			var para2 = parameters.split("&")[1];
			// console.log(para2)

			if ( para1.substr( 0, 4 ) === 'lan=' ) {

				language = para1.substr( 4 );
				// console.log(language)

			}
			try{

				if ( para2.substr( 0, 10 ) === 'savepoint=' ) {
					progress = Number(para2.substr( 10 ));
					// console.log(savepoint);
				}
			} catch {
			}		
	
			function shuffle_banner() {
				var el=document.getElementById("shuffle");	
				rndimg = new Array(
					"./images/cover_1.gif",
					"./images/cover_2.gif",
					"./images/cover_3.gif" 
				);

				var numimages = rndimg.length;
				var imgObjects = [];
				for (var i=0;i < rndimg.length; i++) {
						imgObjects[i] = new Image();
						imgObjects[i].src = rndimg[i]; 
				}

				var x=(Math.floor(Math.random()*numimages));						
				randomimage=(imgObjects[x].src);
				el.src = randomimage ; 
			}



			// // scroll to next panel
			// var p = 1;
			// var nextPage = function() {
			// 	var topPos = document.getElementsByClassName('page')[p++].offsetTop;
			// 	window.scrollTo({top: topPos, behavior: 'smooth'});
			// }

			// // store the users scrolling location 
			// var progress = localStorage.getItem('progress');
			// window.addEventListener("scroll", (event) => {
			// 	let scroll = this.scrollY;
			// 	// console.log(scroll)
			// 	localStorage.setItem('progress', scroll);
			// });


			var cameraSpeedScaler = 1;
			if(isMobile.any()) {
				cameraSpeedScaler = 0.125
			} else {
				cameraSpeedScaler = 0.05
			}



			init();
			loadFiles();
			animate();

			function init() {

				if (running_on_desktop == true){
					renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
					renderer.setPixelRatio(window.devicePixelRatio * 1.333);
					if (developer_mode){
						renderer.setPixelRatio(window.devicePixelRatio * 2);
					}
					renderer.shadowMap.type = THREE.VSMShadowMap;

				}
				else{
					renderer = new THREE.WebGLRenderer( { canvas: canvas, antialias: false } );
					renderer.setPixelRatio( window.devicePixelRatio * 1.2);
					renderer.shadowMap.type = THREE.VSMShadowMap;

				}

				renderer.setClearColor( 0x131313 );
				renderer.shadowMap.enabled = true;
				renderer.outputEncoding = THREE.sRGBEncoding;

				pickingTextureOcclusion = new THREE.WebGLRenderTarget(window.innerWidth / 2, window.innerHeight / 2);

				document.body.addEventListener( 'pointerdown', onPointerDown );
				document.body.addEventListener( 'pointerdown', onPointerDown );
				document.body.addEventListener( 'pointermove', onPointerMove );
				document.body.addEventListener( 'pointerout', onPointerUp );
				document.body.addEventListener( 'pointerup', onPointerUp );

			}

			function onPointerDown( event ) {
				if (!hasClicked){
					hasClicked = true;
					var playPromise = bonusSoundEffect.play(); 
					if (playPromise !== undefined) {
						playPromise.then(_ => {
							bonusSoundEffect.currentTime = 0;
						})
						.catch(error => {
						});
					}
				}

				isPointerDown = true;
				pointerOnDown.x = event.clientX;
				pointerOnDown.y = event.clientY;
				pointer.x = event.clientX;
				pointer.y = event.clientY;


			}

			function onPointerMove( event ) {

				pointer.x = event.clientX;
				pointer.y = event.clientY;

			}

			function onPointerUp() {

				isPointerDown = false;
				isDragging = false;

			}

			// var delay = ( function() {
			// 	var timer = 0;
			// 	return function(callback, ms) {
			// 		clearTimeout (timer);
			// 		timer = setTimeout(callback, ms);
			// 	};
			// })();


			function getScreenPos(object, camera) {
				var pos = object.position.clone();
				camera.updateMatrixWorld();
				pos.project(camera);
				return new THREE.Vector2(pos.x, pos.y);
			}

			function awardBonus(object, camera) {
				if (uncollectedBonuses > 0 )
				{
					bonusSoundEffect.src ='./bonus_achievement.mp3';
					uncollectedBonuses -= 1
					document.getElementById("button_counter").innerHTML = uncollectedBonuses;

				}
				if (uncollectedBonuses == 0 )
				{
					bonusSoundEffect.src ='./bonus_achievement_all.mp3';
					document.getElementById("button_counter").style.visibility = "hidden";
					document.getElementById("bonus_badge").src="./images/bonus_badge_complete.png";
					document.getElementById("awardCertificate").style.display = "block";

				}

				bonusSoundEffect.loop = false;
				bonusSoundEffect.play();
				// var ts = calc_texture_size(size + size * 2 * margin) * 2;
				// var img = new Image();
				// var texture = new THREE.Texture(bonus_canvas);
				// bonus_canvas.width = bonus_canvas.height = ts;
				// context.fillStyle = back_color;
				// context.fillRect(0, 0, bonus_canvas.width, bonus_canvas.height);
				// var boonusLocation = getScreenPos(object, camera);
				// img.addEventListener('load', function(){
				// 	bonus_canvas.drawImage(img, boonusLocation[0], boonusLocation[1]);
				// 	texture.needsUpdate = true;
				// });
				// img.src = './images/bonus_pop.png';

			}


			function isOccludedBuffer(object, scene, camera, rendererm, width, height) {
				renderer.setRenderTarget(pickingTextureOcclusion);
				renderer.render(scene, camera);
				var pixelBuffer  = new Uint8Array(width * height);
				renderer.readRenderTargetPixels(pickingTextureOcclusion, 0, 0, width / 2, height / 2, pixelBuffer);
				renderer.setRenderTarget(null);
				if (pixelBuffer.includes(object.name)){
					return true;
					console.log(object.name + " is visible !!");
				} else {
					return false;
					console.log(object.name + " is not visible !!");
				}
			}

			// function isOccluded(object, scene, camera) {
			// 	raycaster.setFromCamera(getScreenPos(object, camera), camera);
			// 	var intersects = raycaster.intersectObjects(scene.children);
			// 	if (intersects[0] && intersects[0].object === object) {
			// 		return false;
			// 		console.log(object.name + " is not occluded !!");

			// 	} else {
			// 		return true;
			// 		console.log(object.name + " is occluded !!");

			// 	}
			// }

			function inFrustum(object, frustum, camera) {
				frustum.setFromProjectionMatrix(new THREE.Matrix4().multiplyMatrices(camera.projectionMatrix, camera.matrixWorldInverse));
				return frustum.intersectsObject(object);
			}

			function normalize(val, max, min) { 
				return (val - min) / (max - min); 
			}

			function loadFiles() {

				var loader = new THREE.GLTFLoader();
				panelCount = files.length;

				for ( var i = 0; i < files.length; i ++ ) {

					loadFile( files[ i ].replace( '${lan}', language ) );
				}


				async function importRef(scene, glb_file) {
					var ref_data = loader.load( glb_file, function ( gltf ) {
						scene.add( gltf.scene );

						// for object in scene:
							// if object is skeleton
								// ref_skeleton
								// skeleton_bone_list = all bones in skeleton
								// for bone in skeleton_bone_list:
									// get bone in panel_skeleton
									// get bone in ref_skeleton
									// copy bone transform from panel_skeleton to ref_skeleton
									// copy animation from panel_skeleton to ref_skeleton
									// delete panel_skeleton once the ref_skeleton is in place.



					}) 
					return { ref_data };
				}


				var loadedPanelCount = 0;
				function loadFile( path ) {

					var aspect = 1;

					var width = 100;
					var height = 100;

					var parts = path.split( '.' );
					var regex = /^w([0-9]+)h([0-9]+)/;
					var result = regex.exec( parts[ parts.length - 3 ] );

					if ( result !== null ) {

						width = result[ 1 ];
						height = result[ 2 ];

					}

					var element = document.createElement( 'div' );
					element.className = 'panel';
					element.style.display = 'inline-block';
					element.style.width = width + '%';
					// Hack: Maintain aspect ratio in divs
					// https://css-tricks.com/aspect-ratio-boxes/
					element.style.height = '0';
					element.style.paddingTop = ( height / aspect ) + '%';
					content.appendChild( element );

					loader.load( path, function ( gltf ) {

						var scene = gltf.scene;

						var camera, cameraOrigin, cameraTarget, cameraTargetDistance, bonusGemstone, frustum, cameraOrbitSpeed;
						var letters, ref_object, ref_glb_file;

						var isBonusFound = false;
						var isColor = false;

						scene.traverse( function ( child ) {

							if ( /^Camera\d{4}$/.test( child.name ) ) cameraOrigin = child;
							if ( /^Camera_aim\d{4}$/.test( child.name ) ) cameraTarget = child;
							if ( /^Letters_\w+\d{4}$/.test( child.name ) ) letters = child;
							if ( /^Bonus_\d{4}$/.test( child.name ) ) bonusGemstone = child;
							if ( /^ref_/.test( child.name ) ) ref_object = child;

							//

							if ( child.isPerspectiveCamera ) {

								camera = child.clone();
								camera.userData.vFov = camera.fov;
								camera.userData.far = camera.far;

							}

							if ( child.isLight ) {
								child.intensity = 1;
								child.penumbra  = 0;
								child.castShadow = true;
								if (running_on_desktop == true){
									child.shadow.mapSize.set( 2048, 2048 );
									if (developer_mode){
										child.shadow.mapSize.set( 4096, 4096 );
									}
									child.shadow.radius = 3;

								}
								else
								{
									child.shadow.mapSize.set( 1024, 1024 );
									child.shadow.radius = 1;

								}
								// child.shadow.mapSize.set( 512, 512 );
								child.shadow.autoUpdate = false;
								child.shadow.needsUpdate = true;
								child.shadow.camera.near = 1;
								child.shadow.camera.far = 100;
								// child.shadow.camera.far = child.far;
								child.shadow.bias = -0.001;
								// child.shadow.radius = 1;
							}

							if ( child.isMesh && child.material.isMeshStandardMaterial ) {
								child.castShadow = true;
								child.receiveShadow = true;
								var color = child.material.color;
								if (child.userData.toon_color_light) {
									isColor = true;
									toon_color_light = new THREE.Color(child.userData.toon_color_light);
								} 
								toon_color_dark = new THREE.Color(child.userData.toon_color_dark);
								var color = child.material.color;
								var colors = new Uint8Array( [ 255, 255, 255 ] );
								var gradientMap = new THREE.DataTexture( colors, 3, 1, THREE.LuminanceFormat );
								gradientMap.minFilter = THREE.NearestFilter;
								gradientMap.magFilter = THREE.NearestFilter;
								gradientMap.generateMipmaps = false;

								child.material = new THREE.MeshToonMaterial( {
									color: toon_color_light,
									gradientMap: gradientMap,
								} );
								// console.log(child.userData.toon_color_light);
								console.log(child.userData.toon_color_dark);

								// console.log(color);
							}

							if ( child.isMesh && child.material.isMeshBasicMaterial ) {

								child.castShadow = false;
								child.receiveShadow = false;

								var color = child.material.color;
							}
						} );

						if (isColor){
							const light = new THREE.AmbientLight( toon_color_dark ); // soft white light
							scene.add( light );
						}


						var mixer = new THREE.AnimationMixer( scene );
						gltf.animations.forEach( function ( clip ) {

							mixer.clipAction( clip ).play();
							scene.userData.duration = clip.duration;

						} );

						//

						if ( camera ) {

							scene.add( camera );

							if ( cameraOrigin ) {

								camera.position.copy( cameraOrigin.position );
								camera.rotation.copy( cameraOrigin.rotation );
							}

							if ( letters ) {

								letters.position.set( 0, 0, - 2 );
								letters.rotation.set( 0, 0, 0 );

								camera.add( letters );

							}
							
						}



						if ( ref_object ) {
							ref_glb_file = "./panels/" + ref_object.userData.ref_filename;
							console.log(ref_glb_file);
							importRef(scene, ref_glb_file)
						}


						scene.userData.activePanel = false;
						scene.userData.camera = camera;
						scene.userData.cameraOrigin = cameraOrigin;
						scene.userData.cameraTarget = cameraTarget;
						cameraTargetDistance =  cameraOrigin.position.distanceTo(cameraTarget.position);
						cameraFovNormalized = normalize(camera.userData.vFov, 90, 0)
						cameraDistanceNormalized = normalize(cameraTargetDistance, 0, 1)
						cameraOrbitSpeed = cameraFovNormalized / cameraDistanceNormalized
						// cameraOrbitSpeed = camera.userData.vFov / cameraTargetDistance
						scene.userData.cameraOrbitSpeed =  Math.abs(cameraOrbitSpeed  *  (1 + cameraDistanceNormalized) * cameraSpeedScaler);						
						// console.log("cameraOrbitSpeed for " + path + " = " + cameraOrbitSpeed );
						// console.log("camera.userData.vFov for " + path + " = " + camera.userData.vFov );


						if ( bonusGemstone ) {
							scene.userData.bonusGemstone = bonusGemstone;
							var frustum = new THREE.Frustum();
							scene.userData.frustum = frustum;
							scene.userData.isBonusFound = isBonusFound;
							uncollectedBonuses += 1
						}

						scene.userData.element = element;
						scene.userData.mixer = mixer;

						scenes.push( scene );

						loadedPanelCount++;


						if (loadedPanelCount === panelCount){
							// console.log("LOAD COMPLETE")

							// hide load screen
							document.getElementById("loadingscreen").style.display = "none";


							if (uncollectedBonuses == null){
								document.getElementById("prize_banner").style.display = "none";
								document.getElementById("bonus_badge").style.display = "none";
								document.getElementById("button_counter").style.display = "none";

							}
							else{
								var my_html = '';
								my_html += 'and find the <font style="color:rgb(255, 45, 100); font-size: 15pt;"> <b> ' + uncollectedBonuses + '</b></font>';
								my_html += '<font style="color:rgb(255, 255, 255));"><b> HIDDEN BONUSES</b></font>!!!</font>';
								document.getElementById("bonus_count_text").innerHTML = my_html;
							}


							// enable scrolling
							document.body.style.overflow = "scroll";
							shuffle_banner();


							// scroll to last saved progress point
							// if ((progress) & (savepoint == "0"))
							// {
								// console.log(progress);
								// window.onload = function(){ window.scrollTo(0,progress); }
							// }
							// if (savepoint != "0")
							// {
								// console.log(savepoint);
								// window.onload = function(){ window.scrollTop(0,savepoint); }
							// }
						}
					} );

				}

			}
			// console.log(progress);
			
			window.onload = function(){
				window.scrollTo(0,progress);

			}


			function updateSize() {

				var width = canvas.clientWidth;
				var height = canvas.clientHeight;
				var dpr = window.devicePixelRatio;

				if ( canvas.width !== width * dpr || canvas.height !== height * dpr ) {

					renderer.setSize( width, height, false );

				}
				document.getElementById("button_counter").innerHTML = uncollectedBonuses;
				if (uncollectedBonuses != 0){
					document.getElementById("button_counter").style.visibility = "visible";
				}

			}

			function animate() {
				requestAnimationFrame( animate );

				render();

			}

			var clock = new THREE.Clock();
			var speed = -2; //units a second
			var delta = 0;


			function render() {

				updateSize();

				// canvas.style.transform = `translateY(${window.scrollY}px)`;

				renderer.setScissorTest( false );
				renderer.clear();

				renderer.setScissorTest( true );

				scenes.forEach( function ( scene ) {

					var element = scene.userData.element;
					var rect = element.getBoundingClientRect();

					if ( rect.bottom < 0 || rect.top > renderer.domElement.clientHeight ||
							rect.right < 0 || rect.left > renderer.domElement.clientWidth ) {
						if (developer_mode == true){
							last_rendered_panel = scene.name;
							// console.log(last_rendered_panel)
						}
						return; // it's off screen

					}

					var width = rect.right - rect.left;
					var height = rect.bottom - rect.top;
					var left = rect.left;
					var bottom = renderer.domElement.clientHeight - rect.bottom;

					renderer.setViewport( left, bottom, width, height );
					renderer.setScissor( left, bottom, width, height );

					var camera = scene.userData.camera;
					var orbit_ratio_speed_offset = 0;
					camera.aspect = rect.width / rect.height;
					camera.fov = camera.userData.vFov;
					camera.far = camera.userData.far;

					if ( camera.aspect < 1 ) {
						// Use horizontal fov in vertical aspect ratios
						camera.fov = Math.atan( Math.tan( camera.fov * Math.PI / 360 ) / camera.aspect ) * 360 / Math.PI;
					}
					else{
						orbit_ratio_speed_offset =  (rect.width - rect.height) * .0001;
					}

					camera.updateProjectionMatrix();

					var time = THREE.Math.mapLinear( rect.top, renderer.domElement.clientHeight, - rect.height, 0, 1 );
					var duration = scene.userData.duration;

					var mixer = scene.userData.mixer;
					mixer.setTime( time * duration );
					delta = 0; // for bonus collection

					//

					var isPointerInFrameX = pointer.x < rect.right && pointer.x > rect.left;
					var isPointerInFrameY = pointer.y < rect.bottom && pointer.y > rect.top;
					var isPointerInFrame;

					if (isPointerInFrameX && isPointerInFrameY){
						isPointerInFrame = true;
					}
					else {
						isPointerInFrame = false;
					}

					var cameraOrigin = scene.userData.cameraOrigin;
					var cameraTarget = scene.userData.cameraTarget;
					var cameraTargetDistance = scene.userData.cameraTargetDistance;
					var bonusGemstone = scene.userData.bonusGemstone;
					var frustum = scene.userData.frustum;
					var isBonusFound = scene.userData.isBonusFound;
					var cameraOrbitSpeed = scene.userData.cameraOrbitSpeed + orbit_ratio_speed_offset

					if ( cameraOrigin ) {

						// if ( isPointerDown && isPointerInFrame) { 

						// 	// cameraTargetDistanceScaler =  cameraOrbitSpeed * 0.015 * (cameraOrbitSpeed * 0.015);
						// 	camera.position.x = cameraOrigin.position.x - ( ( pointer.x - pointerOnDown.x ) * cameraOrbitSpeed );
						// 	camera.position.y = cameraOrigin.position.y + ( ( pointer.y - pointerOnDown.y ) * cameraOrbitSpeed );
						// 	camera.position.z = cameraOrigin.position.z;

						// 	// console.log("pointer.x = " + pointer.x );

						// 	scene.userData.activePanel = true;

						if ( isPointerInFrame && isPointerDown && !isDragging) { 
							isDragging = true;
							scene.userData.activePanel = true;
						}

						if ( isPointerDown  && scene.userData.activePanel ) { 
							var num = cameraOrigin.position.y + ( ( pointer.y - pointerOnDown.y ) * cameraOrbitSpeed * .4 );

							var number = Math.min(Math.max(parseFloat(num), 0.125), 200);

							camera.position.x = cameraOrigin.position.x - ( ( pointer.x - pointerOnDown.x ) * cameraOrbitSpeed );
							camera.position.y = number;
							camera.position.z = cameraOrigin.position.z;
						} else {

							camera.position.x += ( cameraOrigin.position.x - camera.position.x ) * 0.11;
							camera.position.y += ( cameraOrigin.position.y - camera.position.y ) * 0.12;
							camera.position.z += ( cameraOrigin.position.z - camera.position.z ) * 0.13;	
						}

						if (scene.userData.activePanel){
							if ( !isPointerDown ) { 
								if ( bonusGemstone ) {
								// if (isOccluded(bonusGemstone, scene, camera)) {
									if ( !isBonusFound) {
										if (inFrustum(bonusGemstone, frustum, camera)) {
											if (!isOccludedBuffer(bonusGemstone, scene, camera, renderer, width, height)) {
												clock.stop();
												clock.start();
												var executed = false;
												scene.userData.isBonusFound = true;
												if (!executed) {
													awardBonus(bonusGemstone, camera);
													executed = true;
													console.log("Bonus " + bonusGemstone.name + " Collected!!");
													console.log( uncollectedBonuses + " Bonuses Left!");
													var vanishScale = 0.0001
													bonusGemstone.scale.x = vanishScale;
													bonusGemstone.scale.y = vanishScale;
													bonusGemstone.scale.z = vanishScale;
												}
											}
										}
									}
								}
								
								// if (isBonusFound){
									// vanishScale = 0.0001
									// delta = clock.getDelta();
									// if (bonusGemstone.scale.x > vanishScale) {
									// 	bonusGemstone.scale.x += speed * delta ;
									// 	bonusGemstone.scale.y += speed * delta ;
									// 	bonusGemstone.scale.z += speed * delta ;
									// }
									// else{
									// 	bonusGemstone.scale.x = vanishScale;
									// 	bonusGemstone.scale.y = vanishScale;
									// 	bonusGemstone.scale.z = vanishScale;
									// }
									// console.log("Clock: " + bonusGemstone.scale.x);
								// }
								
							}
						}
						
						if ( !isPointerDown) { 
							scene.userData.activePanel = false;
						}

					}

					if ( cameraTarget ) {

						camera.lookAt( cameraTarget.position );

					}
					if ( isPointerDown ) { 
						if ( bonusGemstone ) {
							bonusGemstone.lookAt( camera.position );
						}
					}



					renderer.render( scene, camera );

				} );


			}
		</script>
		<a name="bottom"></a>
		<div class="footer"  >
			<span>
				<iframe src="https://3dcomic.shop/dev/footer/footer.html" width="100%" frameborder="0" scrolling="no" onload="this.height = this.offsetWidth"></iframe>
			</span>
		</div>
	</body>
	</html>
	